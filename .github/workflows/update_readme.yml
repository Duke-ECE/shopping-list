name: Update README with Shopping List

on:
  push:
    branches: [ main ]

permissions:
  contents: write   # å…è®¸ Actions æäº¤å˜æ›´

jobs:
  update-readme:
    name: ğŸ§¾ Generate README from YAML files
    runs-on: ubuntu-latest

    steps:

      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # âœ… æ‹‰å–å®Œæ•´å†å²ï¼Œé˜²æ­¢ diff å¤±æ•ˆ

      # 2ï¸âƒ£ å®‰è£… Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pip install pyyaml

      # 4ï¸âƒ£ è¿è¡Œæ›´æ–°è„šæœ¬
      - name: Generate updated README
        run: |
          echo "ğŸ› ï¸ Generating README from YAML..."
          python scripts/update_readme.py

      - name: Preview diff before commit
        run: |
          echo "ğŸ” Diff preview after update:"
          git diff README.md || true

      # 5ï¸âƒ£ å¦‚æœè„šæœ¬å¤±è´¥ï¼Œç«‹å³ä¸­æ­¢å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      - name: Verify script execution
        if: ${{ failure() }}
        run: |
          echo "::error::âŒ README update failed. Please ensure README.md contains the required placeholders:"
          echo "<!-- SHOPPING_TABLE_START --> and <!-- SHOPPING_TABLE_END -->"
          exit 1

      # 6ï¸âƒ£ æäº¤æ›´æ”¹
      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          echo "ğŸ” Checking staged diff..."
          git diff --cached || true
          git diff --cached --quiet && echo "âœ… No changes detected, skipping commit." || (
            git commit -m "ğŸ“ Auto-update README after merge [skip ci]" &&
            git push
          )
